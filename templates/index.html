<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AHP Web Application</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap.min.css') }}">
</head>
<body>
<script src="{{ url_for('static', filename='jquery.min.js') }}"></script>
<script src="{{ url_for('static', filename='bootstrap.min.js') }}"></script>
<div class="container">
    <h1 class="mt-5">AHP Web Application</h1>
    <div class="mt-4">
        <h3>Clear AHP model</h3>
        <button class="btn btn-success mt-2" onclick="clearModel()">Clear</button>
    </div>
    <div class="mt-4">
        <h3>Upload Model Parameters</h3>
        <input type="file" id="modelFile" class="form-control">
        <button class="btn btn-primary mt-2" onclick="uploadModel()">Upload</button>
    </div>
    <div class="mt-4">
        <h3>Download Model</h3>
        <input type="text" id="downloadFileName" class="form-control" placeholder="Enter filename (e.g., ahp_model.json)">
        <button class="btn btn-success mt-2" onclick="downloadModel()">Download</button>
    </div>
    <div class="mt-4">
        <h3>Add Alternative</h3>
        <input type="text" id="alternativeName" class="form-control" placeholder="Enter alternative name">
        <button class="btn btn-primary mt-2" onclick="addAlternative()">Add Alternative</button>
    </div>
    <div class="mt-4">
        <h3>Add Criterion</h3>
        <input type="text" id="criterionName" class="form-control" placeholder="Enter criterion name">
        <button class="btn btn-primary mt-2" onclick="addCriterion()">Add Criterion</button>
    </div>
    <div class="mt-4">
        <h3>Add Expert Matrix</h3>
        <input type="text" id="expertName" class="form-control" placeholder="Enter expert name">
        <select id="criterion" class="form-control mt-2"></select>
        <div id="matrixContainer" class="mt-2"></div>
        <button class="btn btn-primary mt-2" onclick="addExpertMatrix()">Add Expert Matrix</button>
    </div>
    <div class="mt-4">
        <h3>Calculate All Rankings</h3>
        <button class="btn btn-success" onclick="calculateAllRankings()">Calculate Rankings</button>
        <div id="rankingResults" class="mt-3"></div>
    </div>
    
    
</div>

<script>
    $(document).ready(function() {
        loadCriteria();
        loadNumberOfAlternatives();
    });

    function loadCriteria() {
        $.ajax({
            url: '/get_criteria',
            type: 'GET',
            success: function(response) {
                const criteriaSelect = $('#criterion');
                criteriaSelect.empty();
                if (response.criteria.length === 0) {
                    criteriaSelect.append(new Option("No criteria available", ""));
                } else {
                    response.criteria.forEach((criterion) => {
                        criteriaSelect.append(new Option(criterion, criterion));
                    });
                }
            },
            error: function() {
                alert('Failed to load criteria');
            }
        });
    }

    function loadNumberOfAlternatives() {
        $.ajax({
            url: '/get_number_of_alternatives',
            type: 'GET',
            success: function(response) {
                const numAlternatives = response.number_of_alternatives;
                generateMatrixInput(numAlternatives);
                updateExpertMatrices();
            },
            error: function() {
                alert('Failed to load the number of alternatives');
            }
        });
    }
function enableReciprocalUpdates() {
    const inputs = document.querySelectorAll(".matrix-input");
    inputs.forEach((input) => {
        input.addEventListener("change", function () {
            const row = parseInt(this.dataset.row, 10);
            const col = parseInt(this.dataset.col, 10);
            const value = parseFloat(this.value);

            const reciprocalInput = document.querySelector(
                `.matrix-input[data-row="${col}"][data-col="${row}"]`
            );

            if (reciprocalInput) {
                if (value === 0) {
                    reciprocalInput.value = "0";
                } else {
                    const reciprocalMap = {
                        "9.00": "0.11",
                        "8.00": "0.13",
                        "7.00": "0.14",
                        "6.00": "0.17",
                        "5.00": "0.20",
                        "4.00": "0.25",
                        "3.00": "0.33",
                        "2.00": "0.50",
                        "1.00": "1.00",
                        "0.50": "2.00",
                        "0.33": "3.00",
                        "0.25": "4.00",
                        "0.20": "5.00",
                        "0.17": "6.00",
                        "0.14": "7.00",
                        "0.13": "8.00",
                        "0.11": "9.00",
                    };

                    reciprocalInput.value =
                        reciprocalMap[value.toFixed(2)];
                }
            }
        });
    });
}

function generateMatrixInput(numAlternatives) {
    const container = $('#matrixContainer');
    container.empty();

    if (numAlternatives > 0) {
        $.ajax({
            url: '/get_alternatives',
            type: 'GET',
            success: function(response) {
                const alternatives = response.alternatives;

                let tableHtml = '<table class="table table-bordered">';
                tableHtml += '<thead><tr><th></th>';

                alternatives.forEach((alt) => {
                    tableHtml += `<th>${alt}</th>`;
                });

                tableHtml += '</tr></thead><tbody>';

                alternatives.forEach((rowAlt, i) => {
                    tableHtml += `<tr><td><strong>${rowAlt}</strong></td>`;
                    for (let j = 0; j < numAlternatives; j++) {
                        if (i === j) {
                            tableHtml += `<td><input type="number" class="form-control" value="1" readonly></td>`;
                        } else {
                            tableHtml += `<td><select class="form-control matrix-input" data-row="${i}" data-col="${j}">`;

                            const values = [9, 8, 7, 6, 5, 4, 3, 2, 1.0, 1 / 2, 1 / 3, 1 / 4, 1 / 5, 1 / 6, 1 / 7, 1 / 8, 1 / 9, 0];
                            values.forEach((value) => {
                                tableHtml += `<option value="${value.toFixed(2)}">${value.toFixed(2)}</option>`;
                            });

                            tableHtml += '</select></td>';
                        }
                    }
                    tableHtml += '</tr>';
                });

                tableHtml += '</tbody></table>';
                container.html(tableHtml);

                enableReciprocalUpdates();
            },
            error: function() {
                alert('Failed to load alternatives.');
            }
        });
    } else {
        container.html('<p>No alternatives available. Please add alternatives first.</p>');
    }
}



    function addAlternative() {
        const alternativeName = $('#alternativeName').val();
        $.ajax({
            url: '/add_alternative',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ alternative_name: alternativeName }),
            success: function(response) {
                alert(response.message);
                loadCriteria();
                loadNumberOfAlternatives();
            },
            error: function(response) {
                alert(response.responseJSON.error);
            }
        });
    }

    function addCriterion() {
        const criterionName = $('#criterionName').val();
        $.ajax({
            url: '/add_criterion',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ criterion_name: criterionName }),
            success: function(response) {
                alert(response.message);
                loadCriteria();
            },
            error: function(response) {
                alert(response.responseJSON.error);
            }
        });
    }

    function addExpertMatrix() {
        const expertName = $('#expertName').val();
        const criterion = $('#criterion').val();
        let numAlternatives = $('#matrixContainer table tr').length;
        let matrix = [];
        for (let i = 0; i < numAlternatives - 1; i++) {
            let row = [];
            for (let j = 0; j < numAlternatives - 1; j++) {
                if (i === j) {
                    row.push(1);
                } else {
                    const value = $(`select[data-row="${i}"][data-col="${j}"]`).val();
                    row.push(parseFloat(value));
                }
            }
            matrix.push(row);
        }

        $.ajax({
            url: '/add_expert_matrix',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ expert_name: expertName, criterion: criterion, matrix: matrix }),
            success: function(response) {
                alert(response.message);
            },
            error: function(response) {
                alert(response.responseJSON.error);
            }
        });
    }

    function calculateFinalRanking() {
        const rankingMethods = [
            { url: '/calculate_final_ranking_topsis', label: 'TOPSIS' },
            { url: '/calculate_final_ranking_consistency_adjusted', label: 'CAM' },
            { url: '/calculate_final_ranking_basic', label: 'BASIC' }
        ];

        let finalRankingHTML = '';

        function fetchRanking(index) {
            if (index >= rankingMethods.length) {
                getInconsistencyIndices();
                return;
            }

            const method = rankingMethods[index];
            $.ajax({
                url: method.url,
                type: 'GET',
                success: function(response) {
                    if (response.ranking) {
                        let rankingHTML = `<h4>Final Ranking (${method.label})</h4>`;
                        rankingHTML += '<ul class="list-group">';
                        response.ranking.forEach((item) => {
                            rankingHTML += `<li class="list-group-item">${item.alternative}: ${item.score.toFixed(2)}</li>`;
                        });
                        rankingHTML += '</ul>';
                        finalRankingHTML += rankingHTML;
                    }
                    fetchRanking(index + 1);
                },
                error: function() {
                    fetchRanking(index + 1);
                }
            });
        }

        fetchRanking(0);
    }


    function uploadModel() {
        const fileInput = $('#modelFile')[0];
        const file = fileInput.files[0];

        if (!file) {
            alert('Please select a file first.');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        $.ajax({
            url: '/upload_model',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                alert(response.message);
                loadCriteria();
                loadNumberOfAlternatives();
            },
            error: function(response) {
                alert(response.responseJSON.error);
            }
        });
    }

    function downloadModel() {
        const filename = $('#downloadFileName').val() || 'ahp_model.json';
        window.location.href = `/download_model?filename=${filename}`;
    }

    function clearModel() {
        $.ajax({
            url: '/clear_model',
            type: 'GET',
            success: function(response) {
                alert(response.message);
                loadCriteria();
                loadNumberOfAlternatives();
            },
            error: function(response) {
                alert(response.responseJSON.error);
            }
        });
    }
    function getInconsistencyIndices() {
        $.ajax({
            url: '/get_inconsistency_indices',
            type: 'GET',
            success: function(response) {
                if (response.inconsistency_indices) {
                    let indicesHTML = '<h4>Inconsistency Indices</h4>';
                    indicesHTML += '<ul class="list-group">';
                    for (const [expert, criteria] of Object.entries(response.inconsistency_indices)) {
                        indicesHTML += `<li class="list-group-item"><strong>Expert: ${expert}</strong>`;
                        indicesHTML += '<ul>';
                        for (const [criterion, index] of Object.entries(criteria)) {
                            indicesHTML += `<li>Criterion: ${criterion}, Index: ${index.toFixed(2)}</li>`;
                        }
                        indicesHTML += '</ul></li>';
                    }
                    indicesHTML += '</ul>';
                    $('#rankingResult').html(indicesHTML);
                } else {
                    $('#rankingResult').html('<p>No inconsistency indices data available.</p>');
                }
            },
            error: function() {
                alert('Failed to get inconsistency indices.');
            }
        });
    }
  

function calculateAllRankings() {
    $.ajax({
        url: '/calculate_all_rankings',
        type: 'GET',
        success: function(response) {
            let resultHTML = '';

            if (response.inconsistency_indices) {
                resultHTML += '<h4>Inconsistency Indices</h4>';
                resultHTML += '<ul class="list-group">';
                for (const [expert, criteria] of Object.entries(response.inconsistency_indices)) {
                    resultHTML += `<li class="list-group-item"><strong>Expert: ${expert}</strong>`;
                    resultHTML += '<ul>';
                    for (const [criterion, index] of Object.entries(criteria)) {
                        resultHTML += `<li>Criterion: ${criterion}, Index: ${index.toFixed(2)}</li>`;
                    }
                    resultHTML += '</ul></li>';
                }
                resultHTML += '</ul>';
            }

            if (response.rankings) {
                for (const [method, rankings] of Object.entries(response.rankings)) {
                    resultHTML += `<h4>Final Ranking (${method})</h4>`;
                    resultHTML += '<ul class="list-group">';
                    rankings.forEach(item => {
                        resultHTML += `<li class="list-group-item">${item.alternative}: ${item.score.toFixed(2)}</li>`;
                    });
                    resultHTML += '</ul>';
                }
            }

            if (response.matrices_with_labels) {
                resultHTML += '<h4>Expert Matrices</h4>';
                for (const [criterion, matrices] of Object.entries(response.matrices_with_labels)) {
                    resultHTML += `<h5>Criterion: ${criterion}</h5>`;
                    matrices.forEach(matrix => {
                        resultHTML += '<table class="table table-bordered"><thead><tr><th></th>';
                        const labels = Object.keys(matrix.values);
                        labels.forEach(label => {
                            resultHTML += `<th>${label}</th>`;
                        });
                        resultHTML += '</tr></thead><tbody>';
                        Object.entries(matrix.values).forEach(([rowLabel, rowValues]) => {
                            resultHTML += `<tr><td>${rowLabel}</td>`;
                            Object.values(rowValues).forEach(value => {
                                resultHTML += `<td>${value.toFixed(2)}</td>`;
                            });
                            resultHTML += '</tr>';
                        });
                        resultHTML += '</tbody></table>';
                    });
                }
            }

            $('#rankingResults').html(resultHTML);
        },
        error: function() {
            alert('Failed to calculate rankings.');
        }
    });
}


</script>
</body>
</html>
